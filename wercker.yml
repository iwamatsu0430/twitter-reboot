test-backend:
  box: 1science/sbt
  steps:
    - script:
      name: run test
      code: |
        cd backend
        sbt test

build-backend:
  box: 1science/sbt
  steps:
    - script:
      name: build binary
      code: |
        cd backend
        sbt universal:packageBin
    - script:
      name: copy artifacts
      code: cp backend/target/universal/$APP_NAME-$VERSION.zip backend/appspec.yml backend/scripts/* $WERCKER_OUTPUT_DIR

deploy-backend:
  box: cgswong/aws
  steps:
    - script:
      name: deploy backend
      code: |
        unzip $APP_NAME-$VERSION.zip
        cp -rp $APP_NAME-$VERSION dist
        mkdir scripts
        cp *.sh scripts
        mkdir build
        tar -cf build/artifact.tar dist scripts
        export AWS_ACCESS_KEY_ID=$S3_ACCESS_KEY
        export AWS_SECRET_ACCESS_KEY=$S3_SECRET_KEY
        export AWS_DEFAULT_REGION=ap-northeast-1
        aws s3 sync --acl-public --delete-removed --verbose ./ s3://$AWS_BUCKET_NAME/build
