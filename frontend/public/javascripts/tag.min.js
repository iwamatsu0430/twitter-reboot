riot.tag("swt-common","",function(t){var e=this,n={auth:{signUp:"/api/auth/signup",signIn:"/api/auth/signin",signOut:"/api/auth/signout"},timeline:{home:"/api/timeline/home"},tweet:{tweet:"/api/tweet/tweet","delete":"/api/tweet/delete/"},value:{count:"/api/value/count/",good:"/api/value/good/",bad:"/api/value/bad/",cancel:"/api/value/cancel/"},contents:"/api/contents/"};window.sawitter=this;var s=window.superagent;this.isLogin=t.isLogin,this.obs=riot.observable(),this.currentKeyCodes=[],this.showErrorMessage=function(t,e){alert(t+"\n"+e.reason)},this.doSignUp=function(t,i,o){t.isEmpty||i.isEmpty||o.isEmpty||s.post(n.auth.signUp).send({mail:t,password:i,passwordConfirm:o}).set("Accept","application/json").end(function(t,n){if(n.ok){var s=JSON.parse(n.text);console.log(s.value),alert("確認アドレスは["+s.value+"]です"),location.reload()}else e.showErrorMessage("登録に失敗しました。",JSON.parse(n.text))})},this.doSignIn=function(t,i){t.isEmpty||i.isEmpty||s.post(n.auth.signIn).withCredentials().send({mail:t,password:i}).set("Accept","application/json").end(function(t,n){n.ok?location.reload():e.showErrorMessage("サインインに失敗しました。",JSON.parse(n.text))})},this.doSignOut=function(){s.post(n.auth.signOut).withCredentials().end(function(t,e){e.ok?location.href="/":alert("サインアウトに失敗しました。もうしばらく待ってから、もう一度お願いします")})},this.findTimeline=function(t,i){var o=n.timeline.home,a=!1,l=function(t,e){a?o+="&":(o+="?",a=!0),o+=t+"="+e};null!=t&&l("before",t),null!=i&&l("after",i),s.get(o).withCredentials().end(function(t,n){var s=JSON.parse(n.text);n.ok&&e.obs.trigger("onLoadTimeline",s.value)})},this.doPost=function(t,i){s.post(n.tweet.tweet).send({url:t,comment:i}).set("Accept","application/json").end(function(t,n){var s=JSON.parse(n.text);n.ok?e.obs.trigger("onPosted"):e.showErrorMessage("ツイートの投稿に失敗しました。",s)})},this.deletePost=function(t){s.del(n.tweet["delete"]+t).end(function(n,s){var i=JSON.parse(s.text);s.ok?e.obs.trigger("onDeleted",t):e.showErrorMessage("ツイートの削除に失敗しました。",i)})},this.putGood=function(t){s.put(n.value.good+t).end(function(n,s){var i=JSON.parse(s.text);s.ok?e.obs.trigger("onValueUpdate",{tweetId:t}):e.showErrorMessage("評価に失敗しました。",i)})},this.putBad=function(t){s.put(n.value.bad+t).end(function(n,s){var i=JSON.parse(s.text);s.ok?e.obs.trigger("onValueUpdate",{tweetId:t}):e.showErrorMessage("評価に失敗しました。",i)})},this.putCancel=function(t){s.del(n.value.cancel+t).end(function(n,s){var i=JSON.parse(s.text);s.ok?e.obs.trigger("onValueUpdate",{tweetId:t}):e.showErrorMessage("評価の取消に失敗しました。",i)})},this.reloadValue=function(t){s.get(n.value.count+t).end(function(n,s){var i=JSON.parse(s.text);s.ok&&e.obs.trigger("onValueReload",{tweetId:t,value:i.value})})},this.findContentsDetail=function(t){s.get(n.contents+t).end(function(t,n){if(n.ok){var s=JSON.parse(n.text).value;e.obs.trigger("onContentsLoaded",s)}})},this.showDetail=function(t){e.obs.trigger("showDetail",t),e.findContentsDetail(t),history.pushState(null,null,"/contents/"+t)},this.generateIcon=function(t){var e=1,n="HEX",s="SHA-512",i=new jsSHA(t,"TEXT"),o=i.getHash(s,n,e);return new Identicon(o,32).toString()},window.addEventListener("keydown",function(t){var n=t.keyCode,s=e.currentKeyCodes.indexOf(n);0>s&&e.currentKeyCodes.push(n)}),window.addEventListener("keyup",function(t){var n=e.currentKeyCodes.indexOf(t.keyCode);n>=0&&e.currentKeyCodes.splice(n,1)}),window.addEventListener("popstate",function(t){e.controller(t.target.location.pathname)}),this.controller=function(t){if("/"==t)e.obs.trigger("hideDetail");else{var n=t.split("/");e.showDetail(n[n.length-1])}}}),riot.tag("swt-contents",'<div class="sg-contents {sg-contents-separate: isDetail}"><swt-cover if="{!isDetail && !sawitter.isLogin}"></swt-cover><swt-tweet if="{!isDetail && sawitter.isLogin}"></swt-tweet><swt-timeline if="{!isDetail}"></swt-timeline><swt-detail if="{isDetail}"></swt-detail><swt-iframe if="{isDetail}"></swt-iframe><swt-modal if="{isShowModal}"></swt-modal></div>',function(t){var e=this;this.isDetail=!1,this.isShowModal=!1,sawitter.obs.on("showDetail",function(){e.isDetail=!0,e.update()}),sawitter.obs.on("hideDetail",function(){e.isDetail=!1,e.update()}),sawitter.obs.on("showModal",function(){e.isShowModal=!0,e.update()}),sawitter.obs.on("hideModal",function(){setTimeout(function(){e.isShowModal=!1,e.update()},300)})}),riot.tag("swt-cover",'<div class="sg-contents-cover"><h1>Sawitter</h1><p>匿名！コメント！楽しい！</p></div>',function(t){}),riot.tag("swt-detail",'<div class="sg-contents-detail"><section><header><h1><a href="{contents.shareContents.url}" target="_blank">{contents.shareContents.title}</a></h1><p>{contents.shareContents.url}</p></header><swt-tweet-comment if="{sawitter.isLogin}" url="{contents.shareContents.url}"></swt-tweet-comment><ul class="sg-contents-timeline-sort"><li><button onclick="{sortByNew}" class="{sg-contents-timeline-sort-active: sortMode == 0}">新着順</button></li><li><button onclick="{sortByGood}" class="{sg-contents-timeline-sort-active: sortMode == 1}">Good順</button></li><li><button onclick="{sortByBad}" class="{sg-contents-timeline-sort-active: sortMode == 2}">Bad順</button></li></ul><ul class="sg-contents-timeline"><li each="{contents.tweets}"><section><dl class="sg-contents-timeline-comment"><dt><img alt="icon" riot-src="data:image/png;base64,{generateIcon(identityHash)}"></dt><dd><p>{tweet.comment}</p><time>{tweet.postedAt}</time></dd></dl><div class="sg-contents-timeline-ismine sg-contents-timeline-ismine-detail" if="{isMine}"><p>あなたのツイート</p><button onclick="{onDeleteTweet}"><i class="fa fa-trash-o"></i></button></div><swt-value-btns value="{value}" tweetid="{tweet.tweetId}"></swt-value-btns></section></li></ul></section></div>',function(t){var e,n=this;!function(t){t[t["new"]=0]="new",t[t.good=1]="good",t[t.bad=2]="bad"}(e||(e={})),this.contents={},this.sortMode=e["new"],this.onDeleteTweet=function(t){t.preventDefault(),confirm("このツイートを削除しますか")&&sawitter.deletePost(t.item.tweet.tweetId)},this.sortByNew=function(t){t.preventDefault(),n.sortMode=e["new"],n.sort()},this.sortByGood=function(t){t.preventDefault(),n.sortMode=e.good,n.sort()},this.sortByBad=function(t){t.preventDefault(),n.sortMode=e.bad,n.sort()},sawitter.obs.on("onContentsLoaded",function(t){n.contents=t,n.sort(),n.update()}),sawitter.obs.on("onPosted",function(){void 0!=n.contents.shareContents&&setTimeout(function(){sawitter.findContentsDetail(n.contents.shareContents.shareContentsId)},1e3)}),sawitter.obs.on("onDeleted",function(t){n.contents.tweets=_.chain(n.contents.tweets).filter(function(e){return e.tweet.tweetId!=t}).value(),n.update()}),sawitter.obs.on("onValueUpdate",function(t){setTimeout(function(){sawitter.reloadValue(t.tweetId)},1e3)}),sawitter.obs.on("onValueReload",function(t){n.contents.tweets=_.chain(n.contents.tweets).map(function(e){return e.tweet.tweetId==t.tweetId&&(e.value=t.value),e}).value(),n.update()}),this.generateIcon=function(t){var e=sawitter.generateIcon(t);return e},this.sort=function(){n.contents.tweets=_.chain(n.contents.tweets).sortBy(function(t){switch(n.sortMode){case e["new"]:return t.tweet.timestamp;case e.good:return t.value.good;case e.bad:return t.value.bad}}).reverse().value(),n.update()}}),riot.tag("swt-footer",'<footer class="sg-footer"><div class="sg-container"><p>(c)2015 SAW</p></div></footer>',function(t){}),riot.tag("swt-header",'<header class="sg-header"><h1 class="sg-header-logo"><a href="/"><i class="fa fa-user-secret fa"></i> Sawitter</a></h1><ul><li if="{sawitter.isLogin}" class="sg-header-tweet"><a href="#" onclick="{tweetNews}"><i class="fa fa-pencil-square-o"></i></a></li><li class="sg-header-signs"><button if="{!sawitter.isLogin}" onclick="{onSignin}" class="sg-header-signin">サインイン</button><button if="{!sawitter.isLogin}" onclick="{onSignup}" class="sg-header-signup">登録</button><button if="{sawitter.isLogin}" onclick="{onSignout}" class="sg-header-signout">サインアウト</button></li></ul></header><form name="signin" class="sg-header-signs-signin" if="{false}"><label>メールアドレス</label><input type="text" name="signinMail" placeholder="メールアドレス"><label>パスワード(6~32桁の英数小大文字)</label><input type="password" name="signinPassword" placeholder="6~32桁の英数小大文字"></form><form name="signup" class="sg-header-signs-signup" if="{false}"><label>メールアドレス</label><input type="text" name="signupMail" placeholder="メールアドレス"><label>パスワード</label><input type="password" name="signupPassword" placeholder="6~32桁の英数小大文字"><label>パスワード(再確認)</label><input type="password" name="signupPasswordConfirm" placeholder="6~32桁の英数小大文字"></form>',function(t){var e=this;this.tweetNews=function(t){t.preventDefault();var e=10,n=60,s=window.scrollY/n,i=function(){var t=window.scrollY,o=t-s,o=0>=o?0:o;t>0?(window.scrollTo(0,o),o>0?setTimeout(i,e/n):sawitter.obs.trigger("onReadyPost")):sawitter.obs.trigger("onReadyPost")};i()},this.onSignin=function(t){t.preventDefault(),sawitter.obs.trigger("showModal",{title:"サインイン",raw:e.signin.innerHTML,okButtonMsg:"サインイン",ngButtonMsg:"キャンセル",ok:function(t){var e=t.querySelector('input[name="signinMail"]').value.trim(),n=t.querySelector('input[name="signinPassword"]').value.trim();return""==e?void alert("メールアドレスが入力されていません"):""==n?void alert("パスワードが入力されていません"):void sawitter.doSignIn(e,n)},ng:function(t){sawitter.obs.trigger("hideModal")}})},this.onSignup=function(t){t.preventDefault(),sawitter.obs.trigger("showModal",{title:"登録",raw:e.signup.innerHTML,okButtonMsg:"登録",ngButtonMsg:"キャンセル",ok:function(t){var e=t.querySelector('input[name="signupMail"]').value.trim(),n=t.querySelector('input[name="signupPassword"]').value.trim(),s=t.querySelector('input[name="signupPasswordConfirm"]').value.trim();return""==e?void alert("メールアドレスが入力されていません"):""==n?void alert("パスワードが入力されていません"):""==s?void alert("パスワード(再確認)が入力されていません"):void sawitter.doSignUp(e,n,s)},ng:function(t){sawitter.obs.trigger("hideModal")}})},this.onSignout=function(t){t.preventDefault(),sawitter.doSignOut()}}),riot.tag("swt-iframe",'<iframe class="sg-contents-iframe" name="contentsIframe"></iframe>',function(t){var e=this;sawitter.obs.on("onContentsLoaded",function(t){e.contentsIframe.src=t.shareContents.url})}),riot.tag("swt-modal",'<div class="sg-contents-modal"><div class="{sg-contents-modal-bg: isShowModal}" onclick="{closeModal}"></div><div if="{isShowModal}" class="sg-contents-modal-contents"><section><header class="sg-contents-modal-contents-header"><h1>{contents.title}</h1></header><div if="{contents.raw != null}" name="raw" class="sg-contents-modal-contents-raw"></div><div if="{contents.msg != null}">{contents.msg}</div><div if="{contents.msgSub != null}" class="sg-contents-modal-contents-msg-sub">{contents.msgSub}</div><footer class="sg-contents-modal-contents-footer"><ul><li><button onclick="{onOk}" class="sg-contents-modal-btn-ok">{contents.okButtonMsg}</button></li><li><button onclick="{onNg}" class="sg-contents-modal-btn-ng">{contents.ngButtonMsg}</button></li></ul></footer></section></div></div>',function(t){var e=this;this.isShowModal=!1,this.contents={},this.closeModal=function(t){t.preventDefault(),sawitter.obs.trigger("hideModal")},this.onOk=function(t){t.preventDefault(),e.contents.ok(e.raw)},this.onNg=function(t){t.preventDefault(),e.contents.ng(e.raw)},sawitter.obs.on("showModal",function(t){e.contents=t,e.raw.innerHTML=t.raw,setTimeout(function(){e.isShowModal=!0,e.update()},1)}),sawitter.obs.on("hideModal",function(){e.contents={},e.raw.innerHTML="",e.isShowModal=!1,e.update()})}),riot.tag("swt-timeline",'<ul class="sg-contents-timeline {sg-contents-timeline-detail: isDetail}"><li each="{tweets}"><dl class="sg-contents-timeline-share"><dt><a href="/content/{shareContents.shareContentsId}" onclick="{onClickDetail}"><img riot-src="{shareContents.thumbnailUrl}" alt="{shareContents.title}"></a></dt><dd><h1><a href="/content/{shareContents.shareContentsId}" onclick="{onClickDetail}"> {shareContents.title} </a></h1></dd></dl><div class="sg-contents-timeline-ismine" if="{isMine}"><p>あなたのツイート</p><button onclick="{onDeleteTweet}"><i class="fa fa-trash-o"></i></button></div><dl class="sg-contents-timeline-comment"><dt><i class="fa fa-user fa-2x"></i></dt><dd><p>{tweet.comment}</p><time>{tweet.postedAt}</time></dd></dl><swt-value-btns value="{value}" tweetid="{tweet.tweetId}"></swt-value-btns></li></ul><div class="sg-contents-timeline-past"><button onclick="{findPastTweet}">さらに20件取得</button></div>',function(t){var e=this;this.isDetail=!1,this.tweets=[],this.onClickDetail=function(t){t.preventDefault();var e=sawitter.currentKeyCodes.indexOf(91),n=sawitter.currentKeyCodes.indexOf(93);(e>=0||n>=0)&&window.open(t.item.shareContents.url);var s=t.item.shareContents.shareContentsId;sawitter.showDetail(s)},this.onDeleteTweet=function(t){t.preventDefault(),confirm("このツイートを削除しますか")&&sawitter.deletePost(t.item.tweet.tweetId)},this.findPastTweet=function(t){t.preventDefault(),sawitter.findTimeline(e.tweets[e.tweets.length-1].tweet.timestamp,null)},sawitter.obs.on("onLoadTimeline",function(t){e.tweets=_.chain(e.tweets).union(t).uniq(function(t){return t.tweet.tweetId}).sortBy(function(t){return t.tweet.timestamp}).reverse().value(),e.update()}),sawitter.obs.on("showDetail",function(){e.isDetail=!0,e.update()}),sawitter.obs.on("hideDetail",function(){e.isDetail=!1,e.update()}),sawitter.obs.on("onValueUpdated",function(t){e.update()}),sawitter.obs.on("onPosted",function(){setTimeout(n,1e3)}),sawitter.obs.on("onDeleted",function(t){e.tweets=_.chain(e.tweets).filter(function(e){return e.tweet.tweetId!=t}).value(),e.update()}),sawitter.obs.on("onValueUpdate",function(t){setTimeout(function(){sawitter.reloadValue(t.tweetId)},1e3)}),sawitter.obs.on("onValueReload",function(t){e.tweets=_.chain(e.tweets).map(function(e){return e.tweet.tweetId==t.tweetId&&(e.value=t.value),e}).value(),e.update()});var n=function(){e.tweets.length>0?sawitter.findTimeline(null,e.tweets[0].tweet.timestamp):sawitter.findTimeline()},s=function(){n(),setTimeout(s,1e4)};s()}),riot.tag("swt-tweet-comment",'<div class="sg-contents-tweet"><form onsubmit="{onSubmit}"><input type="hidden" value="{opts.url}" name="tweetUrl" ><textarea name="tweetComment" oninput="{onInputComment}" class="sg-contents-tweet-comment-show" placeholder="コメントを入力"></textarea><div class="sg-contents-tweet-submit"><span class="{sg-contents-tweet-submit-invalid: commentLength > 140}"><small>{commentLength}</small></span><button __disabled="{commentLength <= 0 || commentLength > 140}">投稿</button></div></form></div>',function(t){var e=this;this.commentLength=0,this.onInputComment=function(t){e.commentLength=t.target.value.length,e.update()},this.onSubmit=function(t){t.preventDefault();var n=e.tweetUrl,s=e.tweetComment,i=n.value.trim(),o=s.value.trim();return""==i?void alert("URLを入力してください"):""==o?void alert("コメントを入力してください"):void sawitter.obs.trigger("showModal",{title:"投稿確認",msg:o,msgSub:"WEBページ("+i+")について、このコメントを投稿してもよろしいでしょうか？",okButtonMsg:"投稿",ngButtonMsg:"キャンセル",ok:function(){sawitter.doPost(i,o),n.value="",s.value="",e.commentLength=0,sawitter.obs.trigger("hideModal")},ng:function(){sawitter.obs.trigger("hideModal")}})},sawitter.obs.on("onReadyPost",function(){e.tweetComment.focus()})}),riot.tag("swt-tweet",'<form onsubmit="{onSubmit}"><input type="text" name="tweetUrl" oninput="{onInputUrl}" placeholder="気になったWEBページのアドレスを入力"><textarea name="tweetComment" if="{isStartDisplayComment}" oninput="{onInputComment}" class="{sg-contents-tweet-comment-show: isDisplayComment}" placeholder="コメントを入力"></textarea><div class="sg-contents-tweet-submit"><span class="{sg-contents-tweet-submit-invalid: commentLength > 140}"><small>{commentLength}</small></span><button __disabled="{!isDisplayComment || commentLength <= 0 || commentLength > 140}">投稿</button></div></form>','class="sg-contents-tweet"',function(t){var e=this;this.isStartDisplayComment=!1,this.isDisplayComment=!1,this.commentLength=0,this.onInputUrl=function(t){var n=t.target.value;n.length>0?(e.isStartDisplayComment=!0,e.update(),setTimeout(function(){e.isDisplayComment=!0,e.update()},1)):(e.isDisplayComment=!1,e.update(),setTimeout(function(){e.isStartDisplayComment=!1,e.update()},200))},this.onInputComment=function(t){e.commentLength=t.target.value.length,e.update()},this.hideComment=function(){e.isDisplayComment=!1,e.update(),setTimeout(function(){e.isStartDisplayComment=!1,e.update()},200)},this.onSubmit=function(t){t.preventDefault();var n=e.tweetUrl,s=e.tweetComment,i=n.value.trim(),o=s.value.trim();return""==i?void alert("URLを入力してください"):""==o?void alert("コメントを入力してください"):void sawitter.obs.trigger("showModal",{title:"投稿確認",msg:o,msgSub:"WEBページ("+i+")について、このコメントを投稿してもよろしいでしょうか？",okButtonMsg:"投稿",ngButtonMsg:"キャンセル",ok:function(){sawitter.doPost(i,o),n.value="",s.value="",sawitter.obs.trigger("hideModal"),e.commentLength=0,e.hideComment()},ng:function(){sawitter.obs.trigger("hideModal")}})},sawitter.obs.on("onReadyPost",function(){e.tweetUrl.focus()}),sawitter.obs.on("onPosted",function(){})}),riot.tag("swt-value-btns",'<div class="sg-contents-timeline-btn"><div if="{sawitter.isLogin && !opts.value.isValued}"><a class="sg-contents-timeline-btn-good" onclick="{onPutGood}" href="#"><i class="fa fa-thumbs-up"></i> {opts.value.good} <span><i class="fa fa-thumbs-up"></i> Good </span></a></div><div if="{sawitter.isLogin && !opts.value.isValued}"><a class="sg-contents-timeline-btn-bad" onclick="{onPutBad}" href="#"><i class="fa fa-thumbs-down"></i> {opts.value.bad} <span><i class="fa fa-thumbs-down"></i> Bad </span></a></div><div if="{sawitter.isLogin && opts.value.isValued}"><a class="sg-contents-timeline-btn-good sg-contents-timeline-btn-complete" onclick="{onCancel}" href="#"><i class="fa fa-thumbs-up"></i> {opts.value.good} <span>Cancel</span></a></div><div if="{sawitter.isLogin && opts.value.isValued}"><a class="sg-contents-timeline-btn-bad sg-contents-timeline-btn-complete" onclick="{onCancel}" href="#"><i class="fa fa-thumbs-down"></i> {opts.value.bad} <span>Cancel</span></a></div><div if="{!sawitter.isLogin}"><a class="sg-contents-timeline-btn-good"><i class="fa fa-thumbs-up"></i> {opts.value.good} </a></div><div if="{!sawitter.isLogin}"><a class="sg-contents-timeline-btn-bad"><i class="fa fa-thumbs-down"></i> {opts.value.bad} </a></div></div>',function(t){this.onPutGood=function(e){e.preventDefault(),sawitter.putGood(t.tweetid)},this.onPutBad=function(e){e.preventDefault(),sawitter.putBad(t.tweetid)},this.onCancel=function(e){e.preventDefault();var n=confirm("評価を取り消しますか？");n&&sawitter.putCancel(t.tweetid)}});